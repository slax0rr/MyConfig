/*

Copyright 2011-2015 Alex Belozerov, Ilya Stepanov

This file is part of PerfectPixel.

PerfectPixel is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

PerfectPixel is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with PerfectPixel.  If not, see <http://www.gnu.org/licenses/>.

*/
Backbone.GSModel=Backbone.Model.extend({get:function(a){return _.isFunction(this.getters[a])?this.getters[a].call(this):Backbone.Model.prototype.get.call(this,a)},set:function(a,b,c){var d,e;_.isObject(a)||null==a?(d=a,c=b):(d={},d[a]=b);for(e in d)_.isFunction(this.setters[e])&&(d[e]=this.setters[e].call(this,d[e]));return Backbone.Model.prototype.set.call(this,d,c)},getters:{},setters:{}});var Overlay=Backbone.GSModel.extend({defaults:{x:0,y:0,width:300,height:300,opacity:.5,scale:1,filename:"",thumbnailFilename:""},setters:{opacity:function(a){return a=Number(a),0>a?a=0:a>1&&(a=1),a}},initialize:function(){this.image=new OverlayImage,this.image.set("parent",this)},uploadFile:function(a,b){this.image.uploadFile(a,b)},destroy:function(a){this.image.destroy({success:$.proxy(function(){Backbone.GSModel.prototype.destroy.call(this,a)},this)})}}),OverlayCollection=Backbone.Collection.extend({model:Overlay,localStorage:new Backbone.LocalStorage("perfectpixel-overlays")}),OverlayImage=Backbone.GSModel.extend({thumbnailMinWidth:188,thumbnailMinHeight:120,getters:{filename:function(){return this.get("parent").get("filename")},thumbnailFilename:function(){return this.get("parent").get("thumbnailFilename")},width:function(){return this.get("parent").get("width")},height:function(){return this.get("parent").get("height")}},setters:{filename:function(a){return this.get("parent").set("filename",a)},thumbnailFilename:function(a){return this.get("parent").set("thumbnailFilename",a)},width:function(a){return this.get("parent").set("width",a)},height:function(a){return this.get("parent").set("height",a)}},getImageUrlAsync:function(a){this.imageUrl?a(this.imageUrl):this._getImageUrlByFilename(this.get("filename"),$.proxy(function(b){this.imageUrl=b,a(this.imageUrl)},this))},getThumbnailUrlAsync:function(a){this.thumbnailImageUrl?a(this.thumbnailImageUrl):this._getImageUrlByFilename(this.get("thumbnailFilename"),$.proxy(function(b){this.thumbnailImageUrl=b,a(this.thumbnailImageUrl)},this))},uploadFile:function(a,b){if(!a.type.match("image.*"))return alert("File must contain image"),void b();var c=this,d=new FileReader;d.onload=function(d){ExtensionService.sendMessage({type:PP_RequestType.ADDFILE,fileData:bufferToString(d.target.result),fileName:a.name,fileType:a.type},function(d){if(c._handleResponse(d),"OK"==d.status){var e=new DataView(stringToBuffer(d.arrayBuffer)),f=new Blob([e],{type:d.fileType});c.imageUrl=PPImageTools.createBlobUrl(f),c.set("filename",d.fileName),PPImageTools.ResizeBlob(f,c.thumbnailMinWidth,c.thumbnailMinHeight,function(d,e){c.set("width",e.width),c.set("height",e.height),PPImageTools.getArrayBufferFromBlob(d,function(e){ExtensionService.sendMessage({type:PP_RequestType.ADDFILE,fileData:bufferToString(e),fileName:a.name,fileType:d.type},function(a){if(c._handleResponse(a),"OK"==a.status){var d=new DataView(stringToBuffer(a.arrayBuffer)),e=new Blob([d],{type:a.fileType});c.thumbnailUrl=PPImageTools.createBlobUrl(e),c.set("thumbnailFilename",a.fileName),b()}})})})}else b()})},d.onerror=function(a){a.getMessage||"error"==a.type&&"file:"==document.location.protocol&&alert("It looks like you are trying to use the extension on a local html page. Unfortunately, due to security reasons, Chrome doesn't allow scripts to access the local files from the local pages unless you start the browser with --allow-file-access-from-files flag."),b()},d.readAsArrayBuffer(a)},_getImageUrlByFilename:function(a,b){if(a){var c=this;ExtensionService.sendMessage({type:PP_RequestType.GETFILE,fileName:a},function(a){if(c._handleResponse(a),"OK"==a.status)var d=new DataView(stringToBuffer(a.arrayBuffer)),e=new Blob([d],{type:a.fileType}),f=PPImageTools.createBlobUrl(e);b&&b(f,a)})}else b&&b(null)},_handleResponse:function(a){a.message&&a.showToUser&&alert(a.message)},destroy:function(a){var b=[this.get("filename")];this.get("thumbnailFilename")&&b.push(this.get("thumbnailFilename")),ExtensionService.sendMessage({type:PP_RequestType.DELETEFILE,fileName:b},$.proxy(function(b){this._handleResponse(b),"OK"==b.status&&(PPImageTools.revokeBlobUrl(this.imageUrl),PPImageTools.revokeBlobUrl(this.thumbnailImageUrl),a.success&&a.success(b)),a.error&&a.error(b)},this))}}),PerfectPixelModel=Backbone.Model.extend({defaults:{currentOverlayId:null,overlayShown:!1,overlayLocked:!1,overlayInverted:!1,version:0},localStorage:new Backbone.LocalStorage("perfectpixel"),initialize:function(){this.overlays=new OverlayCollection,this.overlays.bind("remove",this.overlayRemoved,this),this.notificationModel=new NotificationModel},getCurrentOverlay:function(){return this.has("currentOverlayId")?this.overlays.get(this.get("currentOverlayId")):null},setCurrentOverlay:function(a){this.save({currentOverlayId:a.id})},isOverlayCurrent:function(a){return this.get("currentOverlayId")===a.id},isOverlayLocked:function(){return this.get("overlayLocked")},moveCurrentOverlay:function(a){var b=this.getCurrentOverlay();return b?((ExtOptions.allowPositionChangeWhenLocked||this.get("overlayShown")&&!this.get("overlayLocked"))&&b.save(a),{x:b.get("x"),y:b.get("y")}):{x:null,y:null}},scaleCurrentOverlay:function(a){var b=this.getCurrentOverlay();return b?((ExtOptions.allowPositionChangeWhenLocked||this.get("overlayShown")&&!this.get("overlayLocked"))&&b.save(a),{scale:b.get("scale")}):{scale:null}},changeCurrentOverlayOpacity:function(a){var b=this.getCurrentOverlay();return b?((ExtOptions.allowPositionChangeWhenLocked||this.get("overlayShown")&&!this.get("overlayLocked"))&&b.save(a),{opacity:b.get("opacity")}):{opacity:null}},toggleOverlayShown:function(){this.save({overlayShown:!this.get("overlayShown")})},showOverlay:function(){this.save({overlayShown:!0})},toggleOverlayLocked:function(){this.save({overlayLocked:!this.get("overlayLocked")})},unlockOverlay:function(){this.save({overlayLocked:!1})},toggleOverlayInverted:function(){this.save({overlayInverted:!this.get("overlayInverted")})},overlayRemoved:function(a){if(a.id===this.get("currentOverlayId")){var b=this.overlays.first();this.save(b?{currentOverlayId:b.id}:{currentOverlayId:null})}},getDefaultLocale:function(){return ExtOptions.defaultLocale},getCurrentLocale:function(){var a=/(.*)-.*/i,b=a.exec(window.navigator.language);return null!=b?b[1]:window.navigator.language}}),Notification=Backbone.GSModel.extend({defaults:{id:0,show:0,text:"default text",minVersion:0,maxVersion:0,expireDate:"10.10.2010"},initialize:function(){},getText:function(){var a=PerfectPixel.getCurrentLocale(),b=this.get("text_"+a);return b||(b=this.get("text_"+PerfectPixel.getDefaultLocale())),b},checkParam:function(a,b){var c=!0,d=new Date,e=new Date(this.get("expireDate")),f=this.defaults.expireDate;return 1!=this.get("show")?!1:(this.get("minVersion")>a&&0!=this.get("minVersion")&&(c=!1),this.get("maxVersion")<a&&0!=this.get("maxVersion")&&(c=!1),d>e&&f!=this.get("expireDate")&&(c=!1),(parseInt(this.get("id"))<parseInt(b)||parseInt(this.get("id"))==parseInt(b))&&(c=!1),c)},destroy:function(){}}),NotificationCollection=Backbone.Collection.extend({defaults:{model:Notification},model:Notification,url:function(){return"https://s3-eu-west-1.amazonaws.com/www.welldonecode.com/perfectpixel/data/notifications.json?random="+Math.random()}}),NotificationModel=Backbone.Model.extend({defaults:{collectionNotifications:new NotificationCollection,currentNotification:new Notification,maxId:0},initialize:function(){var a=this,b=new NotificationCollection;b.fetch({success:$.proxy(function(){ExtensionService.sendMessage({type:PP_RequestType.GetNotifications,keyName:"perfectpixel-notification"},$.proxy(function(c){var d=0;c&&(d=c),a.setMaxId(d),a.setCollection(b)},this))},this)})},setCollection:function(a){var b=new NotificationCollection,c=Converter._getCurrentExtensionVersion(),d=this.get("maxId");a.each(function(a){var e=a.checkParam(c,d);e&&b.add(a)}),this.collectionNotifications=b,this.setCurrentNotification()},getCurrentNotification:function(){return this.currentNotification},setCurrentNotification:function(){this.currentNotification=this.collectionNotifications.length>0?this.collectionNotifications.shift():null,this.trigger("change:currentNotification")},closeCurrentNotification:function(){var a=this.getCurrentNotification();ExtensionService.sendMessage({type:PP_RequestType.SetNotifications,notifyId:a.get("id"),keyName:"perfectpixel-notification"}),this.set("maxId",a.get("id"))},setMaxId:function(a){this.set("maxId",a)}});