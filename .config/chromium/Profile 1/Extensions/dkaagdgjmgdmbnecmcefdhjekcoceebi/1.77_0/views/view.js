/*

Copyright 2011-2015 Alex Belozerov, Ilya Stepanov

This file is part of PerfectPixel.

PerfectPixel is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

PerfectPixel is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with PerfectPixel.  If not, see <http://www.gnu.org/licenses/>.

*/
function getFocusedElement(){var a;return(a=document.activeElement)&&a!=document.body?a:null}var PanelView=Backbone.View.extend({tagName:"div",className:"chromeperfectpixel-panel",id:"chromeperfectpixel-panel",fastMoveDistance:10,opacityChangeDistance:.1,screenBordersElementId:"chromeperfectpixel-window",panelUpdatedFirstTime:!0,_isFrozen:!1,events:{"click .chromeperfectpixel-showHideBtn":"toggleOverlayShown","click .chromeperfectpixel-min-showHideBtn":"toggleOverlayShown","click .chromeperfectpixel-lockBtn":"toggleOverlayLocked","click .chromeperfectpixel-min-lockBtn":"toggleOverlayLocked","click .chromeperfectpixel-invertcolorsBtn":"toggleOverlayInverted","click #chromeperfectpixel-origin-controls button":"originButtonClick","change .chromeperfectpixel-coords":"changeOrigin","change #chromeperfectpixel-opacity":"changeOpacity","changed #chromeperfectpixel-opacity":"onOpacityChanged","change #chromeperfectpixel-scale":"changeScale","dblclick #chromeperfectpixel-panel-header":"panelHeaderDoubleClick","click #chromeperfectpixel-header-logo":"panelHeaderDoubleClick","click #chromeperfectpixel-closeNotification":"closeCurrentNotification"},initialize:function(){_.bindAll(this),PerfectPixel.bind("change",this.update),PerfectPixel.overlays.bind("add",this.appendOverlay),PerfectPixel.overlays.bind("remove",this.update),PerfectPixel.overlays.bind("change",this.update),PerfectPixel.overlays.bind("reset",this.reloadOverlays),PerfectPixel.notificationModel.on("change:currentNotification",this.updateNotification);var a=this;ExtensionService.sendMessage({type:PP_RequestType.getTabId},function(b){a.model=new Panel({id:b.tabId}),a.model.fetch(),a.listenTo(a.model,"change",a.updatePanel),a.render(),PerfectPixel.fetch(),PerfectPixel.overlays.fetch(),a._isMobileEnvironment()&&(a.model.set("collapsed",!0),a.model.set({position:{top:0,right:0,left:"auto"}}))})},updatePanel:function(a){this.$el.toggleClass("hidden",a.attributes.hidden),this.$el.toggleClass("vertical",a.attributes.vertical),this.panelUpdatedFirstTime?this.$el.toggleClass("collapsed",a.attributes.collapsed):(this.$el.addClass("collapsing"),this.$el.toggleClass("collapsed",a.attributes.collapsed,{duration:250,complete:$.proxy(function(){this.$el.removeClass("collapsing")},this)}));var b=a.attributes.position;this.$el.css(b);for(var c in b)0==b[c]&&this.$el.addClass("attached-"+c);this.panelUpdatedFirstTime=!1},appendOverlay:function(a){var b=new OverlayItemView({model:a});$(b.render().el).insertBefore("#chromeperfectpixel-layers #chromeperfectpixel-layers-add-btn"),this.update()},reloadOverlays:function(){this.$("#chromeperfectpixel-layers").prevAll("#chromeperfectpixel-layers-add-btn").remove(),PerfectPixel.overlays.each($.proxy(function(a){this.appendOverlay(a)},this)),this.update()},upload:function(a){if(!a.type.match("image.*"))return void alert("File must contain image");this.$("#chromeperfectpixel-progressbar-area").show();var b=new Overlay;b.uploadFile(a,$.proxy(function(){this.$("#chromeperfectpixel-progressbar-area").hide();var a=this.$("#chromeperfectpixel-fileUploader");a.unbind("change"),a.parent().html(a.parent().html()),this._bindFileUploader(),PerfectPixel.overlays.add(b),ExtOptions.NewLayerMoveToScrollPosition&&b.set("y",$(window).scrollTop()),b.save(),(!PerfectPixel.getCurrentOverlay()||ExtOptions.NewLayerMakeActive)&&PerfectPixel.setCurrentOverlay(b),ExtOptions.NewLayerShow&&PerfectPixel.showOverlay(),ExtOptions.NewLayerUnlock&&PerfectPixel.unlockOverlay()},this))},toggleOverlayShown:function(a){return $(a.currentTarget).is("[disabled]")?!1:(trackEvent("overlay",PerfectPixel.get("overlayShown")?"hide":"show"),void PerfectPixel.toggleOverlayShown())},toggleOverlayLocked:function(a){return $(a.currentTarget).is("[disabled]")?!1:(trackEvent("overlay",PerfectPixel.get("overlayLocked")?"unlock":"lock"),void PerfectPixel.toggleOverlayLocked())},toggleOverlayInverted:function(a){return $(a.currentTarget).is("[disabled]")?!1:(trackEvent("overlay",PerfectPixel.get("overlayInverted")?"un-invert":"invert"),void PerfectPixel.toggleOverlayInverted())},originButtonClick:function(a){var b=this.$(a.currentTarget);trackEvent("coords",b.attr("id").replace("chromeperfectpixel-",""));var c=PerfectPixel.getCurrentOverlay();if(c){var d=b.data("axis"),e=b.data("offset");a.shiftKey&&(e*=this.fastMoveDistance),"x"==d?PerfectPixel.moveCurrentOverlay({x:c.get("x")-e}):"y"==d&&PerfectPixel.moveCurrentOverlay({y:c.get("y")-e})}},changeOrigin:function(a){var b=$(a.currentTarget);trackEvent("coords",b.attr("id").replace("chromeperfectpixel-",""));var c=PerfectPixel.getCurrentOverlay();if(c){var d=b.data("axis"),e=parseInt(b.val());switch(isNaN(e)&&(e=0),d){case"x":var f=PerfectPixel.moveCurrentOverlay({x:e});b.val(f.x||"");break;case"y":var f=PerfectPixel.moveCurrentOverlay({y:e});b.val(f.y||"")}}},changeOpacity:function(a){if(!this.$(a.currentTarget).is(":disabled")){var b=PerfectPixel.getCurrentOverlay();if(b){var c=this.$(a.currentTarget),d=c.val(),e=PerfectPixel.changeCurrentOverlayOpacity({opacity:Number(d).toFixed(1)});c.val(e.opacity||1)}}},onOpacityChanged:function(a){trackEvent("opacity",a.type,100*a.currentTarget.value)},changeScale:function(a){var b=this.$(a.currentTarget),c=b.val();trackEvent("scale",a.type,10*c);var d=PerfectPixel.getCurrentOverlay();if(d){var e=PerfectPixel.scaleCurrentOverlay({scale:Number(c).toFixed(2)});b.val(Number(e.scale)||1)}},panelHeaderDoubleClick:function(a){trackEvent(this.$(a.currentTarget).attr("id").replace("chromeperfectpixel-",""),a.type),this.model.toggleCollapsed()},closeCurrentNotification:function(){var a=PerfectPixel.notificationModel.getCurrentNotification();trackEvent("notification","close",null,a.get("id")),PerfectPixel.notificationModel.closeCurrentNotification()},keyDown:function(a){if(!$(a.target).is(".title[contenteditable]")){var b=PerfectPixel.getCurrentOverlay(),c=$(a.target).is("input");if(b){var d=a.shiftKey?this.fastMoveDistance:1;if(!a.metaKey&&a.altKey&&83==a.which)PerfectPixel.toggleOverlayShown();else if(!a.metaKey&&a.altKey&&67==a.which)PerfectPixel.toggleOverlayLocked();else if(!a.metaKey&&a.altKey&&72==a.which)this.model.toggleHidden();else if(!a.metaKey&&a.altKey&&73==a.which)PerfectPixel.toggleOverlayInverted();else{if(!ExtOptions.allowHotkeysPositionChangeWhenLocked&&PerfectPixel.isOverlayLocked())return;if(37!=a.which||c)if(38!=a.which||c)if(39!=a.which||c)if(40!=a.which||c)if(189!=a.which&&109!=a.which||c){if(187!=a.which&&107!=a.which||c)return;PerfectPixel.changeCurrentOverlayOpacity({opacity:Number(Number(b.get("opacity"))+this.opacityChangeDistance).toFixed(1)})}else PerfectPixel.changeCurrentOverlayOpacity({opacity:Number(Number(b.get("opacity"))-this.opacityChangeDistance).toFixed(1)});else PerfectPixel.moveCurrentOverlay({y:b.get("y")+d});else PerfectPixel.moveCurrentOverlay({x:b.get("x")+d});else PerfectPixel.moveCurrentOverlay({y:b.get("y")-d});else PerfectPixel.moveCurrentOverlay({x:b.get("x")-d})}a.stopPropagation(),a.preventDefault()}}},update:function(){var a=PerfectPixel.getCurrentOverlay();a&&PerfectPixel.get("overlayShown")?(this.overlayView||(this.overlayView=new OverlayView,$("body").append(this.overlayView.render().el)),this.$(".chromeperfectpixel-showHideBtn span").text(ExtensionService.getLocalizedMessage("hide")),this.$(".chromeperfectpixel-min-showHideBtn").text("v")):(this.overlayView&&(this.overlayView.unrender(),delete this.overlayView),this.$(".chromeperfectpixel-showHideBtn span").text(ExtensionService.getLocalizedMessage("show")),this.$(".chromeperfectpixel-min-showHideBtn").text("i")),this.overlayView&&(this.overlayView.setLocked(PerfectPixel.get("overlayLocked")),this.overlayView.setInverted(PerfectPixel.get("overlayInverted")));var b=0==PerfectPixel.overlays.size(),c=this.$(".chromeperfectpixel-min-showHideBtn,.chromeperfectpixel-min-lockBtn");b?c.attr("disabled",""):c.removeAttr("disabled"),this.$(".chromeperfectpixel-showHideBtn").button({disabled:b}),this.$(".chromeperfectpixel-lockBtn").button({disabled:b}),this.$(".chromeperfectpixel-lockBtn span").text(ExtensionService.getLocalizedMessage(PerfectPixel.get("overlayLocked")?"unlock":"lock")),this.$(".chromeperfectpixel-min-lockBtn").text(PerfectPixel.get("overlayLocked")?"l":"u"),this.$(".chromeperfectpixel-invertcolorsBtn").button({disabled:b}),this.$(".chromeperfectpixel-invertcolorsBtn span").text(ExtensionService.getLocalizedMessage(PerfectPixel.get("overlayInverted")?"uninvert_colors":"invert_colors")),this.$("#chromeperfectpixel-origin-controls button").button({disabled:b}),this.$("input").not("input[type=file]").attr("disabled",function(){return b}),a?(this.$("#chromeperfectpixel-coordX").val(a.get("x")),this.$("#chromeperfectpixel-coordY").val(a.get("y")),this.$("#chromeperfectpixel-opacity").val(Number(a.get("opacity"))),this.$("#chromeperfectpixel-scale").val(Number(a.get("scale")))):(this.$("#chromeperfectpixel-coordX").val(""),this.$("#chromeperfectpixel-coordY").val(""),this.$("#chromeperfectpixel-opacity").val(.5),this.$("#chromeperfectpixel-scale").val(1))},updateNotification:function(){var a=PerfectPixel.notificationModel.getCurrentNotification(),b=$("#chromeperfectpixel-notification-box"),c=$("#chromeperfectpixel-notification-text"),d=$("#chromeperfectpixel-closeNotification");a?(c.html(a.getText()),d.data("id",a.get("id")),trackEvent("notification","show",null,a.get("id")),b.show()):b.hide()},togglePanelShown:function(){$("#chromeperfectpixel-panel").toggle();var a=$("#chromeperfectpixel-panel").is(":visible")?"open":"hidden";ExtensionService.sendMessage({type:PP_RequestType.PanelStateChange,state:a})},render:function(){$("body").append(this.$el).append('<div id="'+this.screenBordersElementId+'"/>'),this.$el.css("background","url("+ExtensionService.getResourceUrl("images/noise.jpg")+")"),this.$el.addClass(ExtensionService.getLocalizedMessage("panel_css_class"));var a='<div id="chromeperfectpixel-dropzone-decorator"></div><div id="chromeperfectpixel-panel-header"><div id="chromeperfectpixel-header-logo" style="background:url('+ExtensionService.getResourceUrl("images/icons/16.png")+') center center no-repeat;" title="'+ExtensionService.getLocalizedMessage("toggle_collapsed_mode")+'"></div><h1>'+ExtensionService.getLocalizedMessage("extension_name_short")+'</h1></div><div id="chromeperfectpixel-min-buttons"><div class="chromeperfectpixel-min-showHideBtn"></div><div class="chromeperfectpixel-min-lockBtn"></div></div><div id="chromeperfectpixel-panel-body"><div id="chromeperfectpixel-notification-box"><div id="chromeperfectpixel-notification-text"></div><div id="chromeperfectpixel-closeNotification">x</div></div><div id="chromeperfectpixel-section"><div id="chromeperfectpixel-section-opacity"><span>'+ExtensionService.getLocalizedMessage("opacity")+':</span><input type="range" id="chromeperfectpixel-opacity" min="0" max="1" step="0.01" value="0.5" /></div><div id="chromeperfectpixel-section-origin"><span>'+ExtensionService.getLocalizedMessage("origin")+':</span><div id="chromeperfectpixel-origin-controls"><button id="chromeperfectpixel-ymore" data-axis="y" data-offset="-1">&darr;</button><button id="chromeperfectpixel-yless" data-axis="y" data-offset="1">&uarr;</button><button id="chromeperfectpixel-xless" data-axis="x" data-offset="1">&larr;</button><button id="chromeperfectpixel-xmore" data-axis="x" data-offset="-1">&rarr;</button><div><div><div class="chromeperfectpixel-coords-label">X:</div><input type="text" class="chromeperfectpixel-coords" data-axis="x" id="chromeperfectpixel-coordX" value="50" size="2" maxlength="4"/></div><div><div class="chromeperfectpixel-coords-label">Y:</div><input type="text" class="chromeperfectpixel-coords" data-axis="y" id="chromeperfectpixel-coordY" value="50" size="2" maxlength="4"/></div></div></div></div><div>'+ExtensionService.getLocalizedMessage("layers")+':</div><div id="chromeperfectpixel-section-scale"><div id="chromeperfectpixel-section-scale-label">'+ExtensionService.getLocalizedMessage("scale")+':</div><input type="number" id="chromeperfectpixel-scale" value="1.0" size="3" min="0.1" max="10" step="0.1"/></div><div id="chromeperfectpixel-layers"><div id="chromeperfectpixel-layers-add-btn" class="chromeperfectpixel-layers-btn"><div class="chromeperfectpixel-layers-btn-text">'+ExtensionService.getLocalizedMessage("add_new_layer_top")+'</div></div></div><div id="chromeperfectpixel-progressbar-area" style="display: none">'+ExtensionService.getLocalizedMessage("loading")+"...</div>"+(ExtOptions.disableSupportedByAd?"":'<div id="chromeperfectpixel-supported-by">'+ExtensionService.getLocalizedMessage("supported_by")+':<a href="javascript:;" id="chromeperfectpixel-supported-by-disable" title="'+ExtensionService.getLocalizedMessage("supported_by_disable_tooltip")+'">'+ExtensionService.getLocalizedMessage("supported_by_disable_link")+'?</a></div><div id="chromeperfectpixel-ad"><iframe name="chromeperfectpixel-ad-window" srcdoc=\'<html id="chromeperfectpixel-sponsored"><head><base target="_blank" /><link href="'+ExtensionService.getResourceUrl("styles/style.css")+'" type="text/css" rel="stylesheet"/></head><body>'+("https:"==document.location.protocol?'<script async type="text/javascript" src="'+ExtensionService.getResourceUrl("ads/carbon.modified.js?zoneid=1696&serve=CVYD42T&placement=perfectpixel")+'" id="_carbonads_js"></script>':'<script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1696&serve=CVYD42T&placement=perfectpixel" id="_carbonads_js"></script>')+"</body></html>'></iframe></div>")+'<div id="chromeperfectpixel-buttons"><button class="chromeperfectpixel-showHideBtn" title="Hotkey: Alt + S" style="margin-right: 5px; float:left;">'+ExtensionService.getLocalizedMessage("show")+'</button><button class="chromeperfectpixel-lockBtn" title="Hotkey: Alt + C" style="margin-right: 5px; float:left;">'+ExtensionService.getLocalizedMessage("lock")+'</button><button class="chromeperfectpixel-invertcolorsBtn" title="Hotkey: Alt + I" style="margin-right: 5px; float:left;">'+ExtensionService.getLocalizedMessage("invert_colors")+'</button><div id="chromeperfectpixel-upload-area"><button id="chromeperfectpixel-fakefile">'+ExtensionService.getLocalizedMessage("add_new_layer")+'</button><span><input id="chromeperfectpixel-fileUploader" type="file" accept="image/*" /></span></div></div></div></div>';this.$el.append(a),trackEvent("ads","page_loaded"),ExtOptions.disableSupportedByAd||($("#chromeperfectpixel-supported-by-disable").click(function(){trackEvent("ads","disable_ads_link_click"),ExtensionService.sendMessage({type:PP_RequestType.OpenSettingsPage})}),trackEvent("ads","ads_loaded")),"collapsed"==this.options.state&&($panel_body.hide().addClass("collapsed"),$panel.css("right",30-$panel.width()+"px"),$("#chromeperfectpixel-min-buttons").show()),this.$("#chromeperfectpixel-fakefile").bind("click",function(){trackEvent("layer","add",PerfectPixel.overlays.size()+1),$(this).parent().find("input[type=file]").click()}),this.$("#chromeperfectpixel-layers-add-btn").bind("click",function(){trackEvent("layer","add-top-btn",PerfectPixel.overlays.size()+1),$("#chromeperfectpixel-fakefile").parent().find("input[type=file]").click()}),this._bindFileUploader(),function(a,b){var c,d=a.val(),e=function(){a.trigger("changed")};setInterval(function(){var f=a.val();f!=d&&(c&&clearTimeout(c),c=setTimeout(e,b),d=f)},b)}(this.$("#chromeperfectpixel-opacity"),500);var b=this.model,c=this;this.$el.draggable({handle:"#chromeperfectpixel-panel-header",snap:"#"+this.screenBordersElementId,snapMode:"inner",scroll:!1,stop:function(a,d){var e=$(window),f=e.width(),g=$("#"+c.screenBordersElementId).height(),h=$(a.target),i={left:d.position.left,top:d.position.top,right:f-(d.position.left+h.width()),bottom:g-(d.position.top+h.height())},j=!1,k={};for(var l in i){var m=i[l];0>m&&(j=!0,i[l]=0)}0==i.right?i.left="auto":i.right="auto",0==i.bottom?i.top="auto":i.bottom="auto",k.position=i,j&&!b.get("collapsed")&&(k.collapsed=!0,k.auto_collapsed=!0),0!=i.top&&0!=i.bottom||0==i.left||0==i.right?0!=i.left&&0!=i.right||0==i.top||0==i.bottom||(k.vertical=!0):k.vertical=!1,b.get("collapsed")&&b.get("auto_collapsed")&&0!=i.top&&0!=i.right&&0!=i.bottom&&0!=i.left&&(k.collapsed=!1,k.auto_collapsed=!1),b.save(k)},start:function(){$("#chromeperfectpixel-panel").css({bottom:"auto",right:"auto"}).removeClass("attached-top attached-left attached-right attached-bottom")}}),this._initDropzone(),this.updatePanel(this.model),ExtOptions.enableHotkeys&&$("body").on("keydown",this.keyDown),this.$("button").button(),this.update()},destroy:function(){ExtOptions.enableHotkeys&&$("body").off("keydown",this.keyDown),this.overlayView&&(this.overlayView.unrender(),delete this.overlayView),this.$el.remove(),$("#"+this.screenBordersElementId).remove()},_bindFileUploader:function(){var a=this,b=this.$("#chromeperfectpixel-fileUploader");b.bind("change",function(){a.upload(this.files[0])})},_initDropzone:function(){var a=this,b=this.$el,c=this.$("#chromeperfectpixel-dropzone-decorator");b.on("dragover",function(a){a.originalEvent.dataTransfer.dropEffect="copy",a.preventDefault(),a.stopPropagation(),c.addClass("chromeperfectpixel-dropzone-decorator-hover")}),b.on("dragleave",function(){c.removeClass("chromeperfectpixel-dropzone-decorator-hover")}),b.on("drop",function(b){if(b.preventDefault(),b.stopPropagation(),c.removeClass("chromeperfectpixel-dropzone-decorator-hover"),b.originalEvent.dataTransfer.files.length>0){var d=b.originalEvent.dataTransfer.files[0];trackEvent("dropzone",b.type,"file"),a.upload(d)}})},_isMobileEnvironment:function(){try{return document.createEvent("TouchEvent"),!0}catch(a){return!1}},isFrozen:function(){return this._isFrozen},freeze:function(){this.$el.hide(),this.overlayView&&this.overlayView.freeze(),ExtOptions.enableHotkeys&&$("body").off("keydown",this.keyDown),this._isFrozen=!0},unfreeze:function(){this.$el.show(),this.overlayView&&this.overlayView.unfreeze(),ExtOptions.enableHotkeys&&$("body").on("keydown",this.keyDown),this._isFrozen=!1}}),OverlayItemView=Backbone.View.extend({tagName:"label",className:"chromeperfectpixel-layer",title_template:'<span class="title" contenteditable="plaintext-only"/>',max_title_length:5,events:{dblclick:"dblClick","blur .title":"titleBlur","keydown .title":"titleKeyDown","click .chromeperfectpixel-delete":"remove",'click input[name="chromeperfectpixel-selectedLayer"]':"setCurrentOverlay"},initialize:function(){_.bindAll(this),this.model.bind("change",this.render),this.model.bind("remove",this.unrender),PerfectPixel.bind("change:currentOverlayId",this.update),this.update()},setCurrentOverlay:function(){PerfectPixel.setCurrentOverlay(this.model)},update:function(){this.$el.toggleClass("current",PerfectPixel.isOverlayCurrent(this.model))},titleKeyDown:function(a){if(a.stopPropagation(),13==a.keyCode)$(a.target).blur();else if(a.keyCode>=37&&a.keyCode<=40||8==a.keyCode||46==a.keyCode);else if(a.target.innerText.length>=this.max_title_length){var b=window.getSelection();if(b.extentOffset==b.baseOffset)return!1}},titleBlur:function(a){var b=$(a.target);this.model.save({title:b.text()}),b.text()||b.remove()},dblClick:function(){if(0==this.$el.find(".title").size())var a=$(this.title_template).text("title").appendTo(this.$el).focus();else a=this.$el.find(".title");var b=window.getSelection(),c=document.createRange();c.selectNodeContents(a[0]),b.removeAllRanges(),b.addRange(c)},render:function(){if(0==this.$el.find(".chromeperfectpixel-delete").size()){var a=$('<input type=radio name="chromeperfectpixel-selectedLayer" />');this.$el.append(a);var b=$('<button class="chromeperfectpixel-delete">&#x2718;</button>');b.button(),this.$el.append(b),this.$el.attr("title",ExtensionService.getLocalizedMessage("layer_change_title_hint"));var c=this.model.get("title");c&&this.$el.append($(this.title_template).text(c))}return this.model.image.getThumbnailUrlAsync($.proxy(function(a){a&&this.$el.css({"background-image":"url("+a+")"})},this)),this},unrender:function(){this.$el.remove()},remove:function(){var a=ExtensionService.getLocalizedMessage("are_you_sure_you_want_to_delete_layer");trackEvent("layer","delete",void 0,"attempt"),!ExtOptions.enableDeleteLayerConfirmationMessage||confirm(a)?(trackEvent("layer","delete",void 0,"confirmed"),this.model.destroy()):trackEvent("layer","delete",void 0,"canceled")}}),OverlayView=Backbone.View.extend({tagName:"img",className:"chromeperfectpixel-overlay",id:"chromeperfectpixel-overlay_3985123731465987",zIndex:2147483646,smartMovementStickBorder:1,_wasVisibleUponFrozen:!1,events:{mousewheel:"mousewheel"},initialize:function(){_.bindAll(this),PerfectPixel.bind("change:currentOverlayId",this.updateModel),this.updateModel(!1)},updateModel:function(a){void 0===a&&(a=!0);var b=PerfectPixel.getCurrentOverlay();b&&(this.model=b,this.model.bind("change",this.updateOverlay),a&&this.updateOverlay())},updateOverlay:function(){var a=this.model.get("width")*this.model.get("scale");this.$el.css("width",a+"px").css("left",this.model.get("x")+"px").css("top",this.model.get("y")+"px").css("opacity",this.model.get("opacity")),this.model.image.getImageUrlAsync($.proxy(function(a){a&&this.$el.attr("src",a)},this))},setLocked:function(a){this.$el.css("pointer-events",a?"none":"auto")},setInverted:function(a){this.$el.css({"-webkit-filter":a?"invert(100%)":"",filter:a?"invert(100%)":""})},mousewheel:function(a){ExtOptions.enableMousewheelOpacity&&(this.model.save(a.originalEvent.wheelDelta<0?{opacity:Number(this.model.get("opacity"))-.05}:{opacity:Number(this.model.get("opacity"))+.05}),a.stopPropagation(),a.preventDefault())},startDrag:function(a,b){var c=$(getFocusedElement());c&&(c.is("input#chromeperfectpixel-opacity")||c.is("input#chromeperfectpixel-coordX")||c.is("input#chromeperfectpixel-coordY"))&&c.blur(),b.helper.data("PPSmart.originalPosition",b.position||{top:0,left:0}),b.helper.data("PPSmart.stickBorder",null)},drag:function(a,b){var c=PerfectPixel.getCurrentOverlay(),d=b.position;if(c)if(a.shiftKey===!0){var e=b.helper.data("PPSmart.originalPosition"),f=Math.abs(e.left-b.position.left),g=Math.abs(e.top-b.position.top),h=b.helper.data("PPSmart.stickBorder");null==h&&(h=Math.abs(f)>=Math.abs(g)?{x:this.smartMovementStickBorder,y:0}:{x:0,y:this.smartMovementStickBorder},b.helper.data("PPSmart.stickBorder",h)),Math.abs(f*h.x)>Math.abs(g*h.y)||Math.abs(f*h.x)==Math.abs(g*h.y)&&h.x>h.y?(d.top=e.top,c.set({x:b.position.left,y:e.top})):(d.left=e.left,c.set({x:e.left,y:b.position.top}))}else c.set({x:b.position.left,y:b.position.top}),b.helper.data("PPSmart.stickBorder",null);return b.helper.data("PPSmart.originalPosition",d),d},stopDrag:function(a,b){var c=PerfectPixel.getCurrentOverlay();c&&PerfectPixel.moveCurrentOverlay({x:b.position.left,y:b.position.top})},render:function(){return this.$el.css({"z-index":this.zIndex,margin:0,padding:0,position:"absolute","background-color":"transparent",display:"block",cursor:"all-scroll",height:"auto","pointer-events":PerfectPixel.get("overlayLocked")?"none":"auto"}),this.updateOverlay(),this.$el.draggable({drag:this.drag,stop:this.stopDrag,start:this.startDrag}),this},unrender:function(){$(this.el).remove()},freeze:function(){this._wasVisibleUponFrozen=$(this.el).is(":visible"),this.$el.hide()},unfreeze:function(){this._wasVisibleUponFrozen&&this.$el.show()}});